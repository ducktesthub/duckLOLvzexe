_G.AutoFarm = true  -- Bật auto farm (true: bật, false: tắt)

local player = game.Players.LocalPlayer
local replicatedStorage = game:GetService("ReplicatedStorage")
local runService = game:GetService("RunService")

-- 🚀 Hàm dịch chuyển tức thời
function teleportTo(position)
    local character = player.Character
    if character and character:FindFirstChild("HumanoidRootPart") then
        character.HumanoidRootPart.CFrame = CFrame.new(position)
    end
end

-- 📜 Hàm nhận nhiệm vụ tự động
function getQuest()
    local level = player.Data.Level.Value
    local questNPC = nil
    local questName = nil

    if level < 15 then
        questNPC = "Bandit Quest Giver"
        questName = "Bandit"
    elseif level < 30 then
        questNPC = "Monkey Quest Giver"
        questName = "Monkey"
    elseif level < 50 then
        questNPC = "Gorilla Quest Giver"
        questName = "Gorilla"
    elseif level < 100 then
        questNPC = "Pirate Quest Giver"
        questName = "Pirate"
    else
        print("Cấp độ chưa hỗ trợ!")
        return
    end

    local questGiver = game.Workspace.NPCs:FindFirstChild(questNPC)
    if questGiver then
        teleportTo(questGiver.HumanoidRootPart.Position + Vector3.new(0, 5, 0))
        task.wait(1)
        replicatedStorage.Remotes.CommF_:InvokeServer("StartQuest", questName, 1)
        print("Đã nhận nhiệm vụ: " .. questName)
    end
end

-- 👹 Hàm tìm quái gần nhất
function getNearestMob()
    local closestMob = nil
    local shortestDistance = math.huge
    for _, mob in pairs(game.Workspace.Enemies:GetChildren()) do
        if mob:FindFirstChild("HumanoidRootPart") and mob:FindFirstChild("Humanoid") and mob.Humanoid.Health > 0 then
            local distance = (mob.HumanoidRootPart.Position - player.Character.HumanoidRootPart.Position).magnitude
            if distance < shortestDistance then
                shortestDistance = distance
                closestMob = mob
            end
        end
    end
    return closestMob
end

-- ⚔️ Auto click đánh quái
function autoClick()
    while _G.AutoFarm do
        replicatedStorage.Remotes.CommF_:InvokeServer("Combat", "Melee")
        task.wait(0.2) -- Tốc độ đánh
    end
end

-- 🛸 Bay nhanh không rơi
function flyNoFall()
    local character = player.Character
    if character and character:FindFirstChild("HumanoidRootPart") then
        local hrp = character.HumanoidRootPart
        runService.Heartbeat:Connect(function()
            if _G.AutoFarm then
                hrp.Velocity = Vector3.new(0, 50, 0) -- Giữ nhân vật trên cao
            end
        end)
    end
end

-- ⚔️ Đánh quái tự động + bay trên đầu quái
function attackMob(mob)
    flyNoFall() -- Bật chế độ bay
    while mob and mob:FindFirstChild("Humanoid") and mob.Humanoid.Health > 0 and _G.AutoFarm do
        teleportTo(mob.HumanoidRootPart.Position + Vector3.new(0, 20, 0)) -- Bay trên đầu quái
        task.wait(0.1)
    end
end

-- 🎮 Chạy Auto Farm
spawn(autoClick) -- Auto click đánh quái
while _G.AutoFarm do
    getQuest()
    local mob = getNearestMob()
    if mob then
        attackMob(mob)
    else
        print("Không tìm thấy kẻ địch, chờ spawn...")
        task.wait(1)
    end
end
