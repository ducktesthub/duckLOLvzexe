local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local PlaceId = game.PlaceId

-- 📢 Thay webhook Discord vào đây
local webhookURL = "https://discord.com/api/webhooks/1337674068643549214/7VEKBq_Q5Bpw2iBTifqaOcAS24ZCZ-jmGLO9ugLZYi_I9fhKKhjGRVaUFyJVY_6Q5Kxz"

-- 🎲 Chỉ nhặt trái từ LEGEND trở lên
local fruitRarity = {
    ["East Dragon"] = 7, ["West Dragon"] = 7, 
    ["Kitsune"] = 6, ["Yeti"] = 5, ["Gas"] = 4.5,  
    ["Leopard"] = 4, ["Dough"] = 4, ["Shadow"] = 4,
    ["Venom"] = 4, ["Control"] = 4, ["Spirit"] = 4,
    ["Buddha"] = 3, ["Blizzard"] = 3, ["Quake"] = 3,
    ["Rumble"] = 3
}

-- 🔍 Tìm trái hiếm nhất gần nhất
local function findBestFruit()
    local bestFruit, bestRarity, minDistance = nil, 0, math.huge
    for _, obj in pairs(workspace:GetChildren()) do
        if obj:IsA("Tool") and fruitRarity[obj.Name] then
            local distance = (obj.Position - Character.HumanoidRootPart.Position).Magnitude
            if fruitRarity[obj.Name] > bestRarity or (fruitRarity[obj.Name] == bestRarity and distance < minDistance) then
                bestRarity, minDistance, bestFruit = fruitRarity[obj.Name], distance, obj
            end
        end
    end
    return bestFruit
end

-- ⚡ Dịch chuyển đến trái ác quỷ
local function teleportToFruit(fruit)
    if fruit then
        Character.HumanoidRootPart.CFrame = fruit.CFrame
        wait(0.5)
    end
end

-- 📢 Gửi tin nhắn về Webhook Discord
local function sendWebhookMessage(fruitName)
    local data = { ["content"] = "📢 **Đã tìm & lưu trữ trái hiếm!** 🍏\n**Trái:** " .. fruitName .. "\n🔗 Server ID: " .. game.JobId }
    local success = pcall(function()
        HttpService:PostAsync(webhookURL, HttpService:JSONEncode(data), Enum.HttpContentType.ApplicationJson, false)
    end)
    if success then print("✅ Webhook gửi thành công!") else print("❌ Webhook lỗi!") end
end

-- 📦 Lưu trữ trái ác quỷ
local function storeFruit(fruitName)
    ReplicatedStorage.Remotes.CommF_:InvokeServer("StoreFruit")
    print("✅ Đã lưu trữ trái: " .. fruitName)
    sendWebhookMessage(fruitName)
end

-- 🔄 Đổi server nếu không có trái
local function hopServer()
    local servers = {}
    local url = "https://games.roblox.com/v1/games/" .. PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"
    local success, response = pcall(function() return HttpService:GetAsync(url) end)

    if success then
        local data = HttpService:JSONDecode(response)
        for _, server in pairs(data.data or {}) do
            if server.playing < server.maxPlayers and server.id ~= game.JobId then
                table.insert(servers, server.id)
            end
        end
    end

    if #servers > 0 then
        print("🔄 Đang chuyển server: " .. servers[1])
        TeleportService:TeleportToPlaceInstance(PlaceId, servers[1], LocalPlayer)
    else
        print("❌ Không tìm thấy server mới!")
    end
end

-- 🚀 Chạy script
while true do
    local fruit = findBestFruit()
    if fruit then
        print("🍏 Tìm thấy trái hiếm: " .. fruit.Name)
        teleportToFruit(fruit)
        wait(1)
        storeFruit(fruit.Name)
    else
        print("❌ Không có trái Legend -> Đổi server")
        hopServer()
    end
    wait(5)
end
